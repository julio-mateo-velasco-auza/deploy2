---
type NavLink = { href: string; label: string };

const { transparent = false } = Astro.props as { transparent?: boolean };
const isActive = (href: string) => Astro.url.pathname === href;

// TODO(claude): ajustar subpath /inbolsaNeo para enlaces, mantener consistencia
// NO dependemos de cookies; el client script usará isPrivateEnabled()
const baseLinks: NavLink[] = [
  { href: '/inbolsaNeo/', label: 'Home' },
  { href: '/inbolsaNeo/valores', label: 'Valores' },
  { href: '/inbolsaNeo/industrias', label: 'Industrias' },
  { href: '/inbolsaNeo/historia', label: 'Historia' },
  { href: '/inbolsaNeo/contacto', label: 'Contacto' },
  // TODO(claude): agregada nueva página soluciones
  { href: '/inbolsaNeo/soluciones', label: 'Soluciones' },
];

// Quitamos Valores e Historia del render principal (van al dropdown)
const otherLinks = baseLinks.filter(
  (l) => l.href !== '/inbolsaNeo/' && 
         l.href !== '/inbolsaNeo/valores' && 
         l.href !== '/inbolsaNeo/historia' &&
         l.href !== '/inbolsaNeo/soluciones'
);

// Links del dropdown
const dropdownLinks: NavLink[] = [
   { href: '/inbolsaNeo/valores', label: 'Valores' },
   { href: '/inbolsaNeo/historia', label: 'Historia' },

];

const solutionAnchors: NavLink[] = [
  { href: '/inbolsaNeo/soluciones#sacos-pp', label: 'Sacos PP' },
  { href: '/inbolsaNeo/soluciones#big-bag', label: 'Big Bag' },
  { href: '/inbolsaNeo/soluciones#telas', label: 'Telas' },
  { href: '/inbolsaNeo/soluciones#hilos-sogas', label: 'Hilos y sogas' },
];
---

<header
  id="siteHeader"
  class={`${transparent ? 'fixed' : 'sticky'} inset-x-0 top-0 z-50 border-b transition-all duration-300
          ${transparent ? 'bg-transparent text-white border-transparent' : 'bg-white/85 text-slate-800 backdrop-blur-md border-slate-200 shadow-sm'}`}
>
  <div class="mx-auto max-w-7xl px-6 h-24 md:h-28 flex items-center justify-between">
  <a href="/inbolsaNeo/" class="inline-flex items-center gap-4" aria-label="Inbolsa">      
  <img
        id="siteLogo"
        src={transparent ? '/inbolsaNeo/logo.png' : '/inbolsaNeo/Black.png'}
        data-logo-white="/inbolsaNeo/logo.png"
        data-logo-black="/inbolsaNeo/Black.png"
        alt="Inbolsa"
        class="h-20 md:h-20 w-auto transition-opacity duration-300"
      />
      <span class="sr-only">Inbolsa</span>
    </a>

    <nav id="main-nav" class="hidden md:flex items-center gap-8 text-base md:text-lg">
      {(() => {
        const l = { href: '/inbolsaNeo/', label: 'Home' };
        const active = isActive(l.href);
        return (
          <a
            href={l.href}
            aria-current={active ? 'page' : undefined}
            class={`${transparent
                ? `relative pb-1 hover:opacity-90 ${active ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
                : `hover:text-brand-700 ${active ? 'text-brand-700 font-medium' : ''}`
              }`}
          >
            {l.label}
          </a>
        );
      })()}

      <!-- Contenedor para Productos (solo visible en modo privado) -->
      <span id="products-link-container" class="hidden"></span>

      <!-- Submenú Soluciones -->
      {(() => {
        const active = isActive('/inbolsaNeo/soluciones');
        const triggerBase = transparent
          ? `relative pb-1 hover:opacity-90 ${active ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
          : `hover:text-brand-700 ${active ? 'text-brand-700 font-medium' : ''}`;
        const panelBase = transparent
          ? 'bg-white/80 text-slate-800 border-white/40 backdrop-blur-xl'
          : 'bg-white text-slate-700 border-slate-200';

        return (
          <div id="soluciones-wrap" class="relative">
            <button
              id="soluciones-btn"
              type="button"
              aria-haspopup="menu"
              aria-expanded={active ? 'true' : 'false'}
              class={`${triggerBase} inline-flex items-center gap-2 select-none rounded-xl px-2 py-1 ${
                transparent ? 'hover:bg-white/10' : 'hover:bg-slate-50'
              }`}
            >
              <span>Soluciones</span>
              <svg class={`h-4 w-4 transition-transform duration-200 ${active ? 'rotate-180' : 'rotate-0'}`} viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
              </svg>
            </button>

            <div
              id="soluciones-menu"
              role="menu"
              aria-label="Submenú Soluciones"
              class={`absolute left-0 mt-3 w-60 rounded-2xl border shadow-xl z-50 origin-top transition-all duration-150 invisible opacity-0 scale-95 pointer-events-none ${panelBase}`}
            >
              <div class={`absolute -top-2 left-6 h-4 w-4 rotate-45 ${
                transparent ? 'bg-white/80 border-l border-t border-white/40' : 'bg-white border-l border-t border-slate-200'
              }`}></div>
              <div class="py-2 text-sm font-medium uppercase tracking-wide">
                <a
                  href="/inbolsaNeo/soluciones"
                  class="block rounded-xl px-4 py-3 transition hover:bg-brand-600/10 hover:text-brand-600"
                >
                  Página principal
                </a>
                <div class="my-2 h-px bg-slate-200/70"></div>
                {solutionAnchors.map((link) => (
                  <a
                    href={link.href}
                    class="block rounded-xl px-4 py-3 text-xs uppercase tracking-wide transition hover:bg-brand-600/10 hover:text-brand-600"
                  >
                    {link.label}
                  </a>
                ))}
              </div>
            </div>
          </div>
        );
      })()}

      <!-- Dropdown "Nosotros" — diseño glass/pill, clic estable -->
      {(() => {
        const anyActive = dropdownLinks.some(d => isActive(d.href));

        const triggerBase = transparent
          ? `relative pb-1 hover:opacity-90 ${anyActive ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
          : `hover:text-brand-700 ${anyActive ? 'text-brand-700 font-medium' : ''}`;

        const panelBase = transparent
          ? 'bg-white/75 text-slate-800 border-white/40 backdrop-blur-xl'
          : 'bg-white text-slate-800 border-slate-200';

        return (
          <div id="nosotros-wrap" class="relative">
            <button
              id="nosotros-btn"
              type="button"
              aria-haspopup="menu"
              aria-expanded={anyActive ? 'true' : 'false'}
              class={`${triggerBase} inline-flex items-center gap-2 select-none rounded-xl px-2 py-1
                      ${transparent ? 'hover:bg-white/10' : 'hover:bg-slate-50'}`}
            >
              <span>Nosotros</span>
              <svg class={`h-4 w-4 transition-transform duration-200 ${anyActive ? 'rotate-180' : 'rotate-0'}`} viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
              </svg>
            </button>

            <!-- Panel glass con caret -->
            <div
              id="nosotros-menu"
              role="menu"
              aria-label="Submenú Nosotros"
              class={`absolute left-0 mt-3 w-60 rounded-2xl border shadow-xl z-50
                      origin-top transition-all duration-150
                      invisible opacity-0 scale-95 pointer-events-none
                      ${panelBase}`}
            >
              <!-- caret -->
              <div class={`absolute -top-2 left-6 h-4 w-4 rotate-45 ${transparent ? 'bg-white/75 border-l border-t border-white/40' : 'bg-white border-l border-t border-slate-200'}`}></div>

              <div class="py-2">
                {dropdownLinks.map((dl) => {
                  const active = isActive(dl.href);
                  return (
                    <a
                      role="menuitem"
                      href={dl.href}
                      class={`group relative mx-2 my-1 flex items-center gap-3 rounded-xl px-4 py-2.5
                              transition
                              ${transparent
                                ? `hover:bg-white/70 ${active ? 'font-medium' : ''}`
                                : `hover:bg-slate-50 ${active ? 'text-brand-700 font-medium' : ''}`
                              }`}
                    >
                      <!-- indicador lateral -->
                      <span class={`absolute left-0 top-1/2 -translate-y-1/2 h-6 w-1 rounded-r-full
                                    ${active ? 'bg-brand-600' : 'bg-transparent group-hover:bg-brand-500/70'}`}></span>
                      <span class="text-[15px] leading-none">{dl.label}</span>
                    </a>
                  );
                })}
              </div>
            </div>
          </div>
        );
      })()}

      {otherLinks.map((l) => {
        const active = isActive(l.href);
        return (
          <a
            href={l.href}
            aria-current={active ? 'page' : undefined}
            class={`${transparent
                ? `relative pb-1 hover:opacity-90 ${active ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
                : `hover:text-brand-700 ${active ? 'text-brand-700 font-medium' : ''}`
              }`}
          >
            {l.label}
          </a>
        );
      })}

      <a
        id="ctaHeader"
        href="/inbolsaNeo/contacto"
        class={`${transparent
          ? 'rounded-2xl border border-white/70 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 md:px-6 md:py-3 transition'
          : 'rounded-2xl bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 md:px-6 md:py-3 transition'
        }`}
      >
        Contáctanos
      </a>
    </nav>
  </div>

  {transparent && (
    <script is:inline>
      (function HeaderScrollInit(){
        var header = document.getElementById('siteHeader');
        var logo   = document.getElementById('siteLogo');
        var cta    = document.getElementById('ctaHeader');

        var whiteSrc = logo && logo.getAttribute('data-logo-white');
        var blackSrc = logo && logo.getAttribute('data-logo-black');

        function setSolidLocal(s) {
          if (!header) return;
          if (s) {
            header.classList.add('bg-white/85','backdrop-blur-md','text-slate-800','border-slate-200','shadow-sm');
            header.classList.remove('bg-transparent','text-white','border-transparent');
            if (logo && blackSrc) logo.setAttribute('src', blackSrc);
            if (cta) cta.className = 'rounded-2xl bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 md:px-6 md:py-3 transition';
          } else {
            header.classList.add('bg-transparent','text-white','border-transparent');
            header.classList.remove('bg-white/85','backdrop-blur-md','text-slate-800','border-slate-200','shadow-sm');
            if (logo && whiteSrc) logo.setAttribute('src', whiteSrc);
            if (cta) cta.className = 'rounded-2xl border border-white/70 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 md:px-6 md:py-3 transition';
          }
        }

        var onScrollLocal = function(){ setSolidLocal(window.scrollY > 16); };
        onScrollLocal();
        window.addEventListener('scroll', onScrollLocal, { passive: true });
      })();
    </script>
  )}

  <!-- Script para mostrar/ocultar Productos solo en modo privado -->
  <script type="module">
    // TODO(claude): compat subcarpeta para rutas al verificar modo privado
    function isPrivateEnabled() {
      try {
        if (localStorage.getItem('inbolsa:qr:ok') === '1') {
          const exp = Number(localStorage.getItem('inbolsa:qr:exp') || '0');
          if (!exp || Date.now() <= exp) { return true; }
        }
        const checkCookie = (name) => document.cookie.split(';').some(c => c.trim().startsWith(name + '='));
        if (checkCookie('inbolsa:qr:ok') || checkCookie('qrauth') || checkCookie('inb_access') || checkCookie('priv_mode')) {
          return true;
        }
        return false;
      } catch (e) { return false; }
    }

    function updateProductsLink() {
      try {
        const container = document.getElementById('products-link-container');
        if (!container) return;
        container.innerHTML = ''; container.classList.add('hidden');

        // TODO(claude): uso de rutas correctas para productos con subcarpeta
        // Verificar patrones de ruta que incluyan la subcarpeta o la ruta relativa
        const isPrivadoPage = location.pathname.endsWith('/privado') || location.pathname.includes('/inbolsaNeo/privado');
        const isProductosPage = location.pathname.endsWith('/productos') || location.pathname.includes('/inbolsaNeo/productos');
        
        if (isPrivateEnabled() || isPrivadoPage || isProductosPage) {
          const link = document.createElement('a');
          link.href = '/inbolsaNeo/productos';
          link.textContent = 'Productos';
          const isAct = isProductosPage;
          link.className = `hover:text-brand-700 ${isAct ? 'text-brand-700 font-medium' : ''}`;
          container.appendChild(link);
          container.classList.remove('hidden');
        }
      } catch {}
    }
    updateProductsLink();
    setInterval(updateProductsLink, 2000);
    window.addEventListener('storage', (e) => {
      if (e.key && (e.key.startsWith('inbolsa:') || e.key === 'qrauth' || e.key === 'inb_access')) updateProductsLink();
    });
  </script>

  <!-- Scripts de los dropdowns (click, fuera/ESC, transiciones) -->
  <script is:inline>
    (function(){
      function setupDropdown(wrapId, btnId, menuId){
        var wrap = document.getElementById(wrapId);
        var btn  = document.getElementById(btnId);
        var menu = document.getElementById(menuId);
        if (!wrap || !btn || !menu) return;

        var open = false;
        function apply() {
          if (open) {
            menu.classList.remove('invisible','opacity-0','scale-95','pointer-events-none');
            menu.classList.add('visible','opacity-100','scale-100','pointer-events-auto');
            btn.setAttribute('aria-expanded','true');
          } else {
            menu.classList.add('invisible','opacity-0','scale-95','pointer-events-none');
            menu.classList.remove('visible','opacity-100','scale-100','pointer-events-auto');
            btn.setAttribute('aria-expanded','false');
          }
        }
        function toggle(){ open = !open; apply(); }
        function close(){ if (!open) return; open = false; apply(); }

        btn.addEventListener('click', function(e){
          e.stopPropagation();
          toggle();
        });

        document.addEventListener('click', function(e){
          if (!open) return;
          if (!wrap.contains(e.target)) close();
        });

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape') close();
        });

        apply();
      }

      setupDropdown('nosotros-wrap','nosotros-btn','nosotros-menu');
      setupDropdown('soluciones-wrap','soluciones-btn','soluciones-menu');
    })();
  </script>
</header>
