---
// WhatsAppWidget.astro - Versión PHP adaptada para inbolsaNeo
// Este componente muestra un botón de WhatsApp flotante con opciones pre-definidas

// Propiedades configurables
const { 
  position = 'right', // 'right' o 'left'
  offset = '20px',    // distancia del borde
  phoneNumber = '59170000000',  // Número con código de país
  welcomeMessage = 'Hola, estoy interesado en saber más sobre los productos de Inbolsa.',
  buttonColor = '#25D366',
  textColor = 'white',
  delay = 1500  // Milisegundos antes de que aparezca
} = Astro.props;

// Asegurarse que el número no tenga el símbolo + (WhatsApp API lo requiere así)
const formattedPhone = phoneNumber.startsWith('+') ? phoneNumber.substring(1) : phoneNumber;

// Codificar el mensaje para URL
const encodedMessage = encodeURIComponent(welcomeMessage);

// Construir la URL de WhatsApp
const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;

// Base path para imágenes (ajustado para inbolsaNeo)
const basePath = import.meta.env.PUBLIC_BASE_URL || "/inbolsaNeo";
---

<div class="whatsapp-widget" 
  data-position={position} 
  data-offset={offset} 
  data-delay={delay}
  data-phone={formattedPhone}>
  <div class="whatsapp-button">
    <a href={whatsappUrl} target="_blank" rel="noopener noreferrer" aria-label="Chat con nosotros en WhatsApp">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 175.216 175.552" fill="currentColor" width="35" height="35">
        <path d="M87.384 13.794c-40.68 0-73.8 33.12-73.848 73.848 0 16.008 5.088 31.536 14.688 44.448l-15.6 46.704 47.904-15.552c12.528 8.784 27.552 13.392 42.84 13.392h.048c40.656 0 73.752-33.12 73.8-73.848-.024-40.728-33.144-73.992-73.832-73.992zm-.072 145.68c-39.528 0-71.688-32.208-71.736-71.784.048-39.6 32.184-71.856 71.784-71.856 39.576 0 71.76 32.232 71.784 71.808v.048c-.048 39.576-32.16 71.784-71.832 71.784zm42.144-53.28c-2.16-1.08-12.72-6.264-14.688-6.96-1.968-.696-3.408-1.056-4.848.96-1.44 2.016-5.544 6.984-6.816 8.376-1.248 1.44-2.496 1.584-4.656.528-2.16-1.056-9.12-3.36-17.376-10.728-6.432-5.712-10.752-12.744-12-14.904-1.248-2.16-.144-3.36 1.032-4.392.96-.96 2.16-2.544 3.24-3.792 1.08-1.248 1.416-2.16 2.16-3.576.744-1.44.36-2.664-.192-3.744-.552-1.08-4.848-11.616-6.624-15.936-1.752-4.152-3.48-3.6-4.848-3.648-1.248-.048-2.688-.048-4.128-.048-1.44 0-3.768.552-5.736 2.616-1.968 2.088-7.488 7.32-7.488 17.856 0 10.536 7.68 20.736 8.76 22.176 1.08 1.44 14.928 23.712 37.008 32.304 21.984 8.568 22.128 5.712 26.112 5.376 3.984-.336 12.864-5.256 14.664-10.344 1.8-5.088 1.8-9.456 1.272-10.344-.48-1.08-1.92-1.68-4.08-2.736z"/>
      </svg>
    </a>
  </div>
  
  <div class="whatsapp-popup">
    <div class="popup-header">
      <div class="popup-title">
        <img src={`${basePath}/images/logo.png`} alt="Inbolsa Logo" class="popup-logo" />
        <div>
          <h3>Inbolsa</h3>
          <p>Responde usualmente en 15 min</p>
        </div>
      </div>
      <button class="popup-close" aria-label="Cerrar popup">×</button>
    </div>
    <div class="popup-body">
      <div class="message received">
        <p>Hola, gracias por contactarnos. ¿En qué podemos ayudarte?</p>
      </div>
      
      <div class="quick-replies">
        <button class="quick-reply-btn" data-message="Quiero información sobre sus productos">
          Información de productos
        </button>
        <button class="quick-reply-btn" data-message="Necesito hablar con un asesor">
          Hablar con un asesor
        </button>
        <button class="quick-reply-btn" data-message="¿Cuáles son sus horarios de atención?">
          Horarios de atención
        </button>
      </div>
    </div>
    <div class="popup-footer">
      <a href={whatsappUrl} target="_blank" rel="noopener noreferrer" class="start-chat-btn">
        Iniciar chat
      </a>
    </div>
  </div>
</div>

<script>
  // Script para manejar la funcionalidad del widget
  document.addEventListener('DOMContentLoaded', () => {
    const widget = document.querySelector('.whatsapp-widget');
    if (!widget) return;
    
    const button = widget.querySelector('.whatsapp-button');
    const popup = widget.querySelector('.whatsapp-popup');
    const closeBtn = widget.querySelector('.popup-close');
    const quickReplyBtns = widget.querySelectorAll('.quick-reply-btn');
    
    // Mostrar widget después del delay especificado
    setTimeout(() => {
      widget.classList.add('visible');
    }, parseInt(widget.dataset.delay || 1500));
    
    // Alternar visibilidad del popup al hacer clic en el botón
    button.addEventListener('click', (e) => {
      e.preventDefault();
      popup.classList.toggle('show');
    });
    
    // Cerrar popup
    closeBtn.addEventListener('click', () => {
      popup.classList.remove('show');
    });
    
    // Manejar respuestas rápidas
    quickReplyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const message = btn.dataset.message;
        const phoneNumber = widget.dataset.phone;
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        
        // Abrir WhatsApp en nueva pestaña
        window.open(whatsappUrl, '_blank');
      });
    });
  });
</script>

<style>
  .whatsapp-widget {
    position: fixed;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    transform: translateY(20px);
    --button-color: var(--button-color, #25D366);
    --text-color: var(--text-color, white);
    --offset: var(--offset, 20px);
  }
  
  .whatsapp-widget.visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  .whatsapp-widget[data-position="right"] {
    right: var(--offset);
    bottom: 20px;
  }
  
  .whatsapp-widget[data-position="left"] {
    left: var(--offset);
    bottom: 20px;
  }
  
  .whatsapp-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: var(--button-color);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  
  .whatsapp-button:hover {
    transform: scale(1.05);
  }
  
  .whatsapp-button a {
    color: var(--text-color);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
  
  .whatsapp-popup {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 300px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
    overflow: hidden;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
  }
  
  .whatsapp-widget[data-position="left"] .whatsapp-popup {
    right: auto;
    left: 0;
  }
  
  .whatsapp-popup.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .popup-header {
    background: var(--button-color);
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .popup-title {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .popup-logo {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: white;
    object-fit: contain;
  }
  
  .popup-title h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }
  
  .popup-title p {
    margin: 0;
    font-size: 12px;
    opacity: 0.8;
  }
  
  .popup-close {
    background: transparent;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
  }
  
  .popup-body {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
  }
  
  .message {
    margin-bottom: 12px;
    max-width: 80%;
  }
  
  .message.received {
    align-self: flex-start;
  }
  
  .message.received p {
    background: #f0f0f0;
    border-radius: 12px 12px 12px 0;
    padding: 10px 12px;
    margin: 0;
    font-size: 14px;
    line-height: 1.4;
    color: #333;
  }
  
  .quick-replies {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .quick-reply-btn {
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 18px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
    text-align: left;
  }
  
  .quick-reply-btn:hover {
    background: #ebebeb;
  }
  
  .popup-footer {
    padding: 12px 16px;
    border-top: 1px solid #f0f0f0;
  }
  
  .start-chat-btn {
    display: block;
    width: 100%;
    background: var(--button-color);
    color: white;
    border: none;
    border-radius: 24px;
    padding: 10px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s;
  }
  
  .start-chat-btn:hover {
    background: #1da851;
  }

  @media (max-width: 480px) {
    .whatsapp-popup {
      width: calc(100vw - 20px);
      max-width: 320px;
      max-height: 60vh;
    }
    
    .whatsapp-widget[data-position="right"] {
      right: 10px;
    }
    
    .whatsapp-widget[data-position="left"] {
      left: 10px;
    }
  }
</style>
